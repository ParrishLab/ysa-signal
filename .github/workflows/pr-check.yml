name: PR Version Check

on:
  pull_request:
    branches: [main]

jobs:
  version-check:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if version changed
        run: |
          # Get current version
          CURRENT_VERSION=$(grep "__version__" _version.py | sed "s/__version__ = '\([^']*\)'/\1/")

          # Get version from main branch
          git fetch origin main
          MAIN_VERSION=$(git show origin/main:_version.py | grep "__version__" | sed "s/__version__ = '\([^']*\)'/\1/")

          echo "Current PR version: $CURRENT_VERSION"
          echo "Main branch version: $MAIN_VERSION"

          if [ "$CURRENT_VERSION" == "$MAIN_VERSION" ]; then
            echo "Error: Version has not been updated in _version.py"
            echo "Please update the version before merging this PR"
            exit 1
          else
            echo "Version updated from $MAIN_VERSION to $CURRENT_VERSION"
          fi

  tests:
    runs-on: macos-latest
    # Only run tests if files other than _version.py were changed
    if: |
      github.event.pull_request.changed_files > 1 ||
      !contains(github.event.pull_request.changed_files, '_version.py')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies and run tests
        run: |
          python -m pip install --upgrade pip
          pip install pytest numpy h5py pybind11
          pytest
